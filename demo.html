<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    </head>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 48vh;
        }
        .container .item {
            text-align: center;
            font-size: 45px;
            height: 33%;
            width: 88%;
            margin: 2px;
        }
    </style>
    <body>
        <div class="container">
            <label id="BPMdisplay" class="item">Press Start</label>
            <button id="startBtn" class="item">Start</button>
            <button onClick="stop()" class="item">stop</button>
        </div>
<script type="text/javascript">
    var startBtn = document.getElementById("startBtn")
    var BPMdisplay = document.getElementById("BPMdisplay");
    var tempoboxy = new function() {
        return {
            num : 0,
            oldtime : 0,
            bpms : new Array(),
            bpm : function() {
                var i = 0;
                var sum = 0;
                var d = new Date();
                var time = d.getHours()*1000*60*60 + d.getMinutes()*1000*60 + d.getSeconds()*1000 + d.getMilliseconds();
                this.bpms[this.num] = 60000/(time-this.oldtime);
                if(this.oldtime==0) { //第一次記數
                    this.oldtime = time;
                    BPMdisplay.innerHTML = "000.00 BPM";
                } else if(this.bpms[this.num]>999) { //連點兩下重置
                    this.reset();
                    BPMdisplay.innerHTML = "over limit";
                    document.onkeydown = undefined;
                } else { //累積記數計算
                    this.oldtime = time;
                    this.num++;
                    var len = this.bpms.length;
                    for(i=0;i<len;i++) sum += this.bpms[i];
                    BPMdisplay.innerHTML = (sum/len).toPrecision(5) + " BPM";
                }
            },
            reset : function() {
                this.num = 0;
                this.oldtime = 0;
                this.bpms = new Array();
            }
        };
    };

    function start(event){
        if(isMobile()) {
            document.onclick = function(e) {
                tempoboxy.bpm()
            }
        } else {
            document.onkeypress = function(e) {
                if( e.keyCode == 32 ) {
                    tempoboxy.bpm()
                }
            }
        }
        startBtn.removeEventListener('click', start, false)
        event.stopPropagation();
        BPMdisplay.innerHTML = 'Ready';
    }
    function stop(){
        startBtn.addEventListener('click', start, false)
        document.onclick = undefined;
        tempoboxy.reset();
        document.onkeypress = undefined;
        BPMdisplay.innerHTML = 'Press Start';
    }
    function isMobile() {
        try{ document.createEvent("TouchEvent"); return true; }
        catch(e){ return false;}
    }
    startBtn.addEventListener('click', start, false)
    console.log(startBtn)
</script>
</body></html>